<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Token Interaction</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/web3/1.5.2/web3.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.0.4/dist/tailwind.min.css" rel="stylesheet">
</head>

<body class="bg-gray-100 p-8">
    <div class="bg-white rounded p-6 shadow-md">
        <div class="mb-4 text-center">
            <button onclick="connectWallet()"
                class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">
                Connect Wallet
            </button>
        </div>
        <div class="mb-4">
            <label for="tokenSelect" class="block text-sm font-medium text-gray-600">Select Token:</label>
            <select id="tokenSelect" class="mt-1 p-2 w-full border rounded-md">
                <option value="0xe9e7CEA3DedcA5984780Bafc599bD69ADd087D56">WTPAg (We the People Silver)</option>
                <option value="0x8AC76a51cc950d9822D68b83fE1Ad97B32Cd580d">WTPAu (We the People Gold)</option>
            </select>
        </div>
        <div class="mb-4">
            <label for="stablecoinSelect" class="block text-sm font-medium text-gray-600">Select Stablecoin:</label>
            <select id="stablecoinSelect" class="mt-1 p-2 w-full border rounded-md">
                <option value="0xe9e7CEA3DedcA5984780Bafc599bD69ADd087D56">BUSD</option>
                <option value="0x8AC76a51cc950d9822D68b83fE1Ad97B32Cd580d">USDC</option>
                <option value="0x55d398326f99059fF775485246999027B3197955">USDT</option>
                <option value="0xd17479997F34dd9156Deef8F95A52D81D265be9c">USDD</option>
                <option value="0x1AF3F329e8BE154074D8769D1FFa4eE058B1DBc3">DAI</option>
            </select>
        </div>
        <div class="mb-4">
            <label class="block text-sm font-medium text-gray-600">Amount to Buy with Stablecoin:</label>
            <input type="number" id="buyAmountStablecoin" class="mt-1 p-2 w-full border rounded-md">
            <button onclick="buyWithStablecoin()"
                class="mt-2 bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">Buy with Selected
                Stablecoin</button>
        </div>
        <div class="mb-4">
            <label class="block text-sm font-medium text-gray-600">Amount to Buy with BNB:</label>
            <input type="number" id="buyAmountBNB" class="mt-1 p-2 w-full border rounded-md">
            <button onclick="buyWithBNB()"
                class="mt-2 bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">Buy with BNB</button>
        </div>
        <div class="mb-4 text-lg font-semibold text-red-500" id="tokenPrice"></div>
    </div>
    <script>
        let web3;
        let contract;

        function connectWallet() {
            if (typeof window.ethereum !== 'undefined') {
                window.ethereum.request({ method: 'eth_requestAccounts' })
                    .then(handleAccountsChanged)
                    .catch(error => console.error(error));
            } else {
                alert('Please install MetaMask or another web3 provider');
            }
        }

        function handleAccountsChanged(accounts) {
            if (accounts.length === 0) {
                alert('Please connect to MetaMask.');
            } else {
                web3 = new Web3(Web3.givenProvider);

                web3.eth.net.getId()
                    .then(networkId => {
                        if (networkId !== 56) {
                            alert('Please connect to the Binance Smart Chain');
                            return;
                        }

                        const contractABI = [{ "inputs": [], "stateMutability": "nonpayable", "type": "constructor" }, { "anonymous": false, "inputs": [{ "indexed": true, "internalType": "address", "name": "owner", "type": "address" }, { "indexed": true, "internalType": "address", "name": "spender", "type": "address" }, { "indexed": false, "internalType": "uint256", "name": "value", "type": "uint256" }], "name": "Approval", "type": "event" }, { "anonymous": false, "inputs": [{ "indexed": true, "internalType": "address", "name": "previousOwner", "type": "address" }, { "indexed": true, "internalType": "address", "name": "newOwner", "type": "address" }], "name": "OwnershipTransferred", "type": "event" }, { "anonymous": false, "inputs": [{ "indexed": true, "internalType": "address", "name": "from", "type": "address" }, { "indexed": true, "internalType": "address", "name": "to", "type": "address" }, { "indexed": false, "internalType": "uint256", "name": "value", "type": "uint256" }], "name": "Transfer", "type": "event" }, { "inputs": [{ "internalType": "address", "name": "owner", "type": "address" }, { "internalType": "address", "name": "spender", "type": "address" }], "name": "allowance", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "view", "type": "function" }, { "inputs": [{ "internalType": "address", "name": "spender", "type": "address" }, { "internalType": "uint256", "name": "amount", "type": "uint256" }], "name": "approve", "outputs": [{ "internalType": "bool", "name": "", "type": "bool" }], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [{ "internalType": "address", "name": "account", "type": "address" }], "name": "balanceOf", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "view", "type": "function" }, { "inputs": [{ "internalType": "uint256", "name": "amount", "type": "uint256" }], "name": "burn", "outputs": [], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [{ "internalType": "address", "name": "account", "type": "address" }, { "internalType": "uint256", "name": "amount", "type": "uint256" }], "name": "burnFrom", "outputs": [], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [{ "internalType": "uint256", "name": "amount", "type": "uint256" }], "name": "buyWithBNB", "outputs": [], "stateMutability": "payable", "type": "function" }, { "inputs": [{ "internalType": "address", "name": "stablecoinAddress", "type": "address" }, { "internalType": "uint256", "name": "amount", "type": "uint256" }], "name": "buyWithStablecoin", "outputs": [], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [], "name": "decimals", "outputs": [{ "internalType": "uint8", "name": "", "type": "uint8" }], "stateMutability": "view", "type": "function" }, { "inputs": [{ "internalType": "address", "name": "spender", "type": "address" }, { "internalType": "uint256", "name": "subtractedValue", "type": "uint256" }], "name": "decreaseAllowance", "outputs": [{ "internalType": "bool", "name": "", "type": "bool" }], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [], "name": "getTokenPriceInBNB", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "getXAUpriceInUSD", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "view", "type": "function" }, { "inputs": [{ "internalType": "address", "name": "spender", "type": "address" }, { "internalType": "uint256", "name": "addedValue", "type": "uint256" }], "name": "increaseAllowance", "outputs": [{ "internalType": "bool", "name": "", "type": "bool" }], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [{ "internalType": "address", "name": "to", "type": "address" }, { "internalType": "uint256", "name": "amount", "type": "uint256" }], "name": "mint", "outputs": [], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [], "name": "name", "outputs": [{ "internalType": "string", "name": "", "type": "string" }], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "owner", "outputs": [{ "internalType": "address", "name": "", "type": "address" }], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "renounceOwnership", "outputs": [], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [], "name": "symbol", "outputs": [{ "internalType": "string", "name": "", "type": "string" }], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "totalSupply", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "view", "type": "function" }, { "inputs": [{ "internalType": "address", "name": "to", "type": "address" }, { "internalType": "uint256", "name": "amount", "type": "uint256" }], "name": "transfer", "outputs": [{ "internalType": "bool", "name": "", "type": "bool" }], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [{ "internalType": "address", "name": "from", "type": "address" }, { "internalType": "address", "name": "to", "type": "address" }, { "internalType": "uint256", "name": "amount", "type": "uint256" }], "name": "transferFrom", "outputs": [{ "internalType": "bool", "name": "", "type": "bool" }], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [{ "internalType": "address", "name": "newOwner", "type": "address" }], "name": "transferOwnership", "outputs": [], "stateMutability": "nonpayable", "type": "function" }];

                        contract = new web3.eth.Contract(contractABI, tokenSelect);

                        setInterval(getPrice, 60000);
                    })
                    .catch(error => console.error(error));
            }
        }

        async function checkAllowance(stablecoinAddress, amount) {
            const stablecoinContract = new web3.eth.Contract(contractABI, stablecoinAddress);
            return await eth.getAccounts()
                .then(accounts => {
                    return stablecoinContract.methods.allowance(accounts[0], tokenSelect).call();
                });
        }

        async function setAllowance(stablecoinAddress, amount) {
            const stablecoinContract = new web3.eth.Contract(contractABI, stablecoinAddress);
            return await web3.eth.getAccounts()
                .then(accounts => {
                    return stablecoinContract.methods.approve(tokenSelect, parseInt(amount) * 10e18).send({ from: accounts[0] });
                });
        }

        async function buyWithStablecoin() {
            const amount = document.getElementById('buyAmountStablecoin').value;
            const stablecoinAddress = document.getElementById('stablecoinSelect').value;

            await checkAllowance(stablecoinAddress, amount)
                .then(allowance => {
                    if (new web3.utils.BN(allowance).lt(new web3.utils.BN(parseInt(amount) * 10e18))) {
                        return setAllowance(stablecoinAddress, amount);
                    }
                })
                .then(() => {
                    return web3.eth.getAccounts();
                })
                .then(accounts => {
                    return contract.methods.buyWithStablecoin(stablecoinAddress, parseInt(amount) * 10e18).send({ from: accounts[0] });
                })
                .then(receipt => {
                    console.log('Transaction Successful:', receipt);
                })
                .catch(error => {
                    console.error(error);
                });
        }

        function buyWithBNB() {
            const amount = document.getElementById('buyAmountBNB').value;

            web3.eth.getAccounts()
                .then(accounts => {
                    contract.methods.buyWithBNB(amount).send({ from: accounts[0], value: amount })
                        .then(receipt => {
                            console.log('Transaction Successful:', receipt);
                        })
                        .catch(error => console.error(error));
                });
        }

        function getPrice() {
            const ankrRPCEndpoint = 'https://rpc.ankr.com/bsc';
            const web3 = new Web3(new Web3.providers.HttpProvider(ankrRPCEndpoint));
            const contractABI = [{ "inputs": [], "stateMutability": "nonpayable", "type": "constructor" }, { "anonymous": false, "inputs": [{ "indexed": true, "internalType": "address", "name": "owner", "type": "address" }, { "indexed": true, "internalType": "address", "name": "spender", "type": "address" }, { "indexed": false, "internalType": "uint256", "name": "value", "type": "uint256" }], "name": "Approval", "type": "event" }, { "anonymous": false, "inputs": [{ "indexed": true, "internalType": "address", "name": "previousOwner", "type": "address" }, { "indexed": true, "internalType": "address", "name": "newOwner", "type": "address" }], "name": "OwnershipTransferred", "type": "event" }, { "anonymous": false, "inputs": [{ "indexed": true, "internalType": "address", "name": "from", "type": "address" }, { "indexed": true, "internalType": "address", "name": "to", "type": "address" }, { "indexed": false, "internalType": "uint256", "name": "value", "type": "uint256" }], "name": "Transfer", "type": "event" }, { "inputs": [{ "internalType": "address", "name": "owner", "type": "address" }, { "internalType": "address", "name": "spender", "type": "address" }], "name": "allowance", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "view", "type": "function" }, { "inputs": [{ "internalType": "address", "name": "spender", "type": "address" }, { "internalType": "uint256", "name": "amount", "type": "uint256" }], "name": "approve", "outputs": [{ "internalType": "bool", "name": "", "type": "bool" }], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [{ "internalType": "address", "name": "account", "type": "address" }], "name": "balanceOf", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "view", "type": "function" }, { "inputs": [{ "internalType": "uint256", "name": "amount", "type": "uint256" }], "name": "burn", "outputs": [], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [{ "internalType": "address", "name": "account", "type": "address" }, { "internalType": "uint256", "name": "amount", "type": "uint256" }], "name": "burnFrom", "outputs": [], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [{ "internalType": "uint256", "name": "amount", "type": "uint256" }], "name": "buyWithBNB", "outputs": [], "stateMutability": "payable", "type": "function" }, { "inputs": [{ "internalType": "address", "name": "stablecoinAddress", "type": "address" }, { "internalType": "uint256", "name": "amount", "type": "uint256" }], "name": "buyWithStablecoin", "outputs": [], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [], "name": "decimals", "outputs": [{ "internalType": "uint8", "name": "", "type": "uint8" }], "stateMutability": "view", "type": "function" }, { "inputs": [{ "internalType": "address", "name": "spender", "type": "address" }, { "internalType": "uint256", "name": "subtractedValue", "type": "uint256" }], "name": "decreaseAllowance", "outputs": [{ "internalType": "bool", "name": "", "type": "bool" }], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [], "name": "getTokenPriceInBNB", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "getXAUpriceInUSD", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "view", "type": "function" }, { "inputs": [{ "internalType": "address", "name": "spender", "type": "address" }, { "internalType": "uint256", "name": "addedValue", "type": "uint256" }], "name": "increaseAllowance", "outputs": [{ "internalType": "bool", "name": "", "type": "bool" }], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [{ "internalType": "address", "name": "to", "type": "address" }, { "internalType": "uint256", "name": "amount", "type": "uint256" }], "name": "mint", "outputs": [], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [], "name": "name", "outputs": [{ "internalType": "string", "name": "", "type": "string" }], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "owner", "outputs": [{ "internalType": "address", "name": "", "type": "address" }], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "renounceOwnership", "outputs": [], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [], "name": "symbol", "outputs": [{ "internalType": "string", "name": "", "type": "string" }], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "totalSupply", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "view", "type": "function" }, { "inputs": [{ "internalType": "address", "name": "to", "type": "address" }, { "internalType": "uint256", "name": "amount", "type": "uint256" }], "name": "transfer", "outputs": [{ "internalType": "bool", "name": "", "type": "bool" }], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [{ "internalType": "address", "name": "from", "type": "address" }, { "internalType": "address", "name": "to", "type": "address" }, { "internalType": "uint256", "name": "amount", "type": "uint256" }], "name": "transferFrom", "outputs": [{ "internalType": "bool", "name": "", "type": "bool" }], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [{ "internalType": "address", "name": "newOwner", "type": "address" }], "name": "transferOwnership", "outputs": [], "stateMutability": "nonpayable", "type": "function" }];

            const contract = new web3.eth.Contract(contractABI, tokenSelect);

            contract.methods.getTokenPriceInBNB().call()
                .then(price => {
                    document.getElementById('tokenPrice').innerText = 'Token Price in BNB: ' + price;
                    console.log(price, "alisa");
                })
                .catch(error => {
                    console.error(error);
                })
                .finally(() => {
                    document.getElementById('loader').style.display = 'none';
                    document.getElementById('content').style.display = 'block';
                });
        }
    </script>

</body>

</html>